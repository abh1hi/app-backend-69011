name: Build iOS App

on:
  push:
    branches: [ "ios" ]
  pull_request:
    branches: [ "ios" ]

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install npm Dependencies
      run: npm install

    - name: Build Vue.js Web App
      run: npm run build

    - name: Install Capacitor Dependencies and Sync
      run: |
        npm install @capacitor/cli @capacitor/core @capacitor/ios
        npx cap sync

    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.0'

    - name: Install CocoaPods Dependencies
      run: pod install
      working-directory: ./ios/App

    - name: Install Apple Certificate and Provisioning Profile
      env:
        IOS_SIGNING_KEY: ${{ secrets.IOS_SIGNING_KEY }}
        IOS_SIGNING_KEY_PASSWORD: ${{ secrets.IOS_SIGNING_KEY_PASSWORD }}
        IOS_PROVISIONING_PROFILE: ${{ secrets.IOS_PROVISIONING_PROFILE }}
        IOS_TEAM_ID: ${{ secrets.IOS_TEAM_ID }}
      run: |
        security create-keychain -p "" build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "" build.keychain
        
        echo $IOS_SIGNING_KEY | base64 --decode > certificate.p12
        security import certificate.p12 -k build.keychain -P $IOS_SIGNING_KEY_PASSWORD -T /usr/bin/codesign
        
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        echo $IOS_PROVISIONING_PROFILE | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/app.mobileprovision
        
    - name: Build Xcode Project
      run: |
        xcodebuild -workspace ./ios/App/App.xcworkspace \
                   -scheme App \
                   -destination 'generic/platform=iOS' \
                   -archivePath $PWD/build/App.xcarchive \
                   "CODE_SIGN_IDENTITY=Apple Distribution" \
                   "PROVISIONING_PROFILE_SPECIFIER=app.mobileprovision" \
                   "DEVELOPMENT_TEAM=${{ secrets.IOS_TEAM_ID }}" \
                   archive
      working-directory: ./ios

    - name: Upload Build Artifact
      uses: actions/upload-artifact@v3
      with:
        name: ios-app
        path: ./ios/build/App.xcarchive
